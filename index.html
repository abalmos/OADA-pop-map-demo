<!DOCTYPE html>
<html>
<head>
  <title>OADA Pop-Map Demo</title>

  <meta charset=utf-8 />
  <meta name='viewport' content='width=device-width, initial-scale=1.0' />
  
  <!-- react.js scripts -->
  <script src="http://fb.me/react-0.11.1.js"></script>
  <script src="http://fb.me/JSXTransformer-0.11.1.js"></script>
  <!-- jquery script -->
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="http://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css" />
  <!-- lodash script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
  <!-- leaflet scripts and styles -->
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <!-- debugging and testing scripts -->
  <!-- TODO: remove -->
  <script src="test/testJSON.js"></script>

  <!-- styling - TODO: put in another file -->
  <style type="text/css">
    .app-container {
      width: 100%;
      height: 100%;
    }
    .map {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      top: 0;
      height: 100%;
      width: 90%;
      float: left;
      z-index: -1;
    }
    .table {
      position: relative;
      height: 100%;
      float: right;
      width: 10%;
      z-index: 0;
    }
  </style>
</head>
<body>
  
  <div id="app-container"></div>
  <div id="dialog" title="Dialog Title" hidden="hidden"></div>


<!-- TODO: put all components in their own jsx files -->
<script type="text/jsx">
    /** @jsx React.DOM */
    
    /* React App Container Component */
    var AppContainer = React.createClass ({
      getInitialState: function() {
        //TODO: Remove hardcoded Authorization String
        var authString = "Bearer SJKF9jf309";
        
        var url = this.getDomainPrompt() + '/.well-known/oada-configuration';
        var base_uri = this.getBaseUri(url);
        var chosen_prescription = this.getChosenPrescription(base_uri, authString);
        
        return {
          baseUri: base_uri,
          prescId: chosen_prescripton._id
        };
      },
      
      getChosenPrescription: function(uri, auth) {
        var all_prescriptions = this.getAllPrescriptions(uri, auth);
        var prescription = this.selectPrescription(all_prescriptions, function(prescription) {
          console.log(prescription);
          return prescription;
        });
      },
      
      selectPrescription: function(list, callbackAfterSelect) {
        var i = 0, buttons = [];
        var list_names = _.keys(list);

        for(i = 0; i < _.size(list); i++) {
          var name = list_names[i];
          buttons[i] = {
            text: "Name = " + name + "\n" +
                 "ID = " + list[name]._id + "\n" +
                 "Rev = " + list[name]._rev,
            click: function() {
              //TODO: decide to return name or list[name]
              $(this).dialog("close");
              return callbackAfterSelect(list[name]);
            }
          }
        };
        
        $( "#dialog" ).dialog({
          dialogClass: "no-close",
          title: "Select Prescription",
          width: 'auto',
          buttons: buttons
        });
      },
      
      getAllPrescriptions: function(uri, auth) {
        var list;
        
        //TODO: fix hardcoded values to work with ajax command below -- problem with using Authorization over ajax. need real username and pass
        var hardcodedResponse = {"_rev":"12-9572628b3bd1b238619a702c6c068a34","planting":{"prescriptions":{"name":"planting.prescriptions","list":{"faa71765-3bee-40ce-b444-8f6d770e2766":{"_rev":"0-0","_id":"509bed2f-e203-457c-8f0f-f52098b99549"},"8d156d7a-0031-4989-a825-6ce00cd91f1c":{"_rev":"0-0","_id":"1b01fb5f-2032-4bee-808f-61ce06124575"},"87728c24-9c38-462d-9738-0209de455577":{"_rev":"0-0","_id":"0ef0512f-2997-4eba-bb97-080a788cc3b2"},"39f6b130-3020-487d-95be-b55d450d30e4":{"_rev":"0-0","_id":"f57a245f-b03f-47bd-8c64-ee415921719c"},"79dec035-ac94-4bdb-8b38-03cb61809e49":{"_rev":"0-0","_id":"b13473e9-ff5e-49d7-9084-57bc667ac8f2"},"524b38cc-2677-423c-9369-8b5f010c7120":{"_rev":"0-0","_id":"071a9ce1-44da-47b1-92d4-53a201cb78a2"},"453636e5-964d-475a-a351-110f1f233638":{"_rev":"0-0","_id":"0172c5e5-78d2-43bc-8713-e0dc19690f5c"},"2a101291-9f86-4642-95b0-fdfccd6e14f5":{"_rev":"0-0","_id":"6ad8aea6-73e1-4e39-bfa2-bfec047bc803"},"4d49b59c-bd91-4efc-9e3f-808644649110":{"_rev":"0-0","_id":"dda57717-bfda-4ca5-a785-3ca524576095"},"9e32f3fe-3aeb-4d14-9737-1aab6027e9a6":{"_rev":"0-0","_id":"62b889a1-b61a-46fe-a9bc-24fe62809c51"},"9f5945ae-fe61-45fa-bc43-77fe63bf0026":{"_rev":"0-0","_id":"10d2089a-0166-4085-a8dc-c089b25450d5"},"43472377-6631-4eff-89cb-6ac18e72c45d":{"_rev":"0-0","_id":"f7593285-ebee-4617-a261-59b4b87dd5da"}}}},"_id":"0346e1ca-24c1-4cb7-829f-f82605dfecc0"};
        
        list = hardcodedResponse.planting.prescriptions.list;
        
        /*
        $.ajax({
          url: uri + "/bookmarks/",
          async: true,
          dataType: 'jsonp',
          headers: {
            "Authorization": "Bearer SJKF9jf309"
          },
          success: function(response) {
            console.log(response);
            console.log(response.planting.prescriptions.list);
            list = response.planting.prescriptions.list;
          },
          error: function(error) {
            
          }
        });
        */
        return list;
      },
      
      getDomainPrompt: function() {
        var domain = prompt("Please enter the OADA Domain", "http://52.4.148.83:3000");
        
        //TODO: Do some checks on whether this domain is valid
        //TODO: Format it correctly based on starting with "http://"" and ending with "/"
        
        return domain;
      },
      
      getBaseUri: function(url) {
        var uri = false;
        
        $.ajax({
          url: url,
          async: false,
          success: function(response) {
            if(response != null && response.oada_base_uri != null) {
              uri = response.oada_base_uri;
          } else { this.error(); }
          },
          error: function(error) {
            alert("Bad Domain");
          }
        });
        
        return uri;
      },
      
      componentWillMount: function() {
        //TODO: Have user select from the list of prescriptions
      },
      
      //TODO: Remove id's of Map and Table and replace with Ref
      render: function () {
        return (
          <div>
            <div className="map">
              <Map data={testJSON} />
            </div>
            <div className="table">
              <Table/>
            </div>
          </div>
        );
      }
    });
    
    /* React Map component */
    var Map = React.createClass({
      createMap: function(element, data) {
        var geojson = data.geojson;
        //TODO: Figure out what this is doing and setup with our own open street map
        var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
          });
        var geomap = L.geoJson(geojson, {
            //TODO: change the colors to be randomly separated and updated based on the # of features
            //TODO: Should change the feature properties to be the population and zone number -- show this in the pop-up instead of the "description"
            onEachFeature: function (feature, layer) {
              //console.log(this);
              var zone = feature.properties.zone;
              layer.bindPopup("zone: " + zone + " with pop: " + data.zones[zone].population.value);
            }
        });
        map = L.map(element);
        tiles.addTo(map);
        geomap.addTo(map);
        map.fitBounds(geomap.getBounds());
        return map;
      },
      
      loadData: function() {
        //TODO: Change this to get the data from the server instead of from the file
        return testJSON;
      },
      
      getInitialState: function() {
        return null;
      },

      componentDidMount: function() {
        data = this.loadData();
        var geojson = data.geojson;
        
        if(this.props.createMap) {
          this.map = this.props.createMap(this.getDOMNode(), data);
        } else {
          this.map = this.createMap(this.getDOMNode(), data);
        }
      },
      
      render: function() {
        return (<div className="map"></div>);
      }
    });
    
    /* Table React Component */
    var Table = React.createClass({
      getInitialState: function() {
        var tabledata = [];
        var length = _.size(testJSON.zones);
        for(i = 0; i < length; i++) {
          
          var name = _.keys(testJSON.zones)[i];
          
          var population = testJSON.zones[name].population.value;
          if(name == "default") {
            population = testJSON.zones[name].population.default.value;
          }
          
          tabledata[i] = {name, population};
        }
        return {zones: tabledata};
      },
      
      //TODO: add "key" value to array as required by React.js -- (key = zone.name ?)
      render: function() {
        var rows = [];
        this.state.zones.forEach(function(zone) {
            rows.push(<ZoneTableRow Zone={zone.name} Population={zone.population} />);
        }.bind(this));
        
        return (
            <table>
                <thead>
                    <tr>
                        <th>Zone</th>
                        <th>Population</th>
                    </tr>
                </thead>
                <tbody>{rows}</tbody>
            </table>
          );
        }
        
      });
      //NOTE: contentEditable is a HTML5 feature. This will require more code on older HTML versioned browsers
      var ZoneTableRow = React.createClass({
        render: function() {
          return (
              <tr>
                <td>{this.props.Zone}</td>
                <td contentEditable='true'>{this.props.Population}</td>
              </tr>
            );
        }
      });
    
    //TODO: move into main.jsx
    /* will go in main.jsx */
    
    var reactComponentAppContainer = React.renderComponent(
      <AppContainer />,
      document.getElementById('app-container')
    );
  </script>


</body>
</html>

