<!DOCTYPE html>
<html>
<head>
  <title>OADA Pop-Map Demo</title>

  <meta charset=utf-8 />
  <meta name='viewport' content='width=device-width, initial-scale=1.0' />
  
  <!-- react.js scripts -->
  <script src="http://fb.me/react-0.11.1.js"></script>
  <script src="http://fb.me/JSXTransformer-0.11.1.js"></script>
  <!-- jquery script -->
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <!-- lodash script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
  <!-- leaflet scripts and styles -->
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <!-- debugging and testing scripts -->
  <!-- TODO: remove -->
  <script src="test/testJSON.js"></script>

  <!-- styling - TODO: put in another file -->
  <style type="text/css">
    .wrapper {
      width: 100%;
      height: 100%;
    }
    .map {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      top: 0;
      height: 100%;
      width: 90%;
      float: left;
      z-index: -1;
    }
    .table {
      position: relative;
      height: 100%;
      float: right;
      width: 10%;
      z-index: 0;
    }
  </style>
</head>
<body>
  
  <div class="wrapper">
    <div id="map" class="map">Map</div>
    <div id="table" class="table">Table</div>
  </div>
  
<!-- TODO: put all components in their own jsx files -->
<script type="text/jsx">
    /** @jsx React.DOM */
    
    //TODO: Remove unused component functions
    /* React Map component */
    var Map = React.createClass({
      createMap: function(element, data) {
        var geojson = data.geojson;
        //TODO: Figure out what this is doing and setup with our own open street map
        var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
          });
        var geomap = L.geoJson(geojson, {
            //TODO: change the colors to be randomly separated and updated based on the # of features
            //TODO: Should change the feature properties to be the population and zone number -- show this in the pop-up instead of the "description"
            onEachFeature: function (feature, layer) {
              //console.log(this);
              var zone = feature.properties.zone;
              layer.bindPopup("zone: " + zone + " with pop: " + data.zones[zone].population.value);
            }
        });
        map = L.map(element);
        tiles.addTo(map);
        geomap.addTo(map);
        map.fitBounds(geomap.getBounds());
        return map;
      },
      

      setupMap: function(data) {
        //this.map.fitBounds(L.geoJson(data.geojson).getBounds());
      },
      
      loadData: function() {
        //TODO: Change this to get the data from the server instead of from the file
        return testJSON;
      },
      
      getInitialState: function() {
        return null;
      },
      
      componentWillMount: function() {
        
      },

      componentDidMount: function() {
        
        data = this.loadData();
        var geojson = data.geojson;
        
        if(this.props.createMap) {
          this.map = this.props.createMap(this.getDOMNode(), data);
        } else {
          this.map = this.createMap(this.getDOMNode(), data);
        }

        this.setupMap(data);
      },
      
      componentWillReceiveProps: function(nextProps) {
        
      },
      
      shouldComponentUpdate: function(nextProps, nextState) {
        return true;
      },
      

      render: function() {
        return (<div className="map"></div>);
      }
    });
    
    //TODO: use or remove TABLE_CONFIG variable
    /* Table React Component */
    var TABLE_CONFIG = {
      sort: { column: "Zone", order: "desc" },
      columns: {
        col1: { name: "Zone", filterText: "", defaultSortOrder: "desc" },
        col2: { name: "Population", filterText: "", defaultSortOrder: "desc" }
      }
    };
    
    var Table = React.createClass({
      getInitialState: function() {
        var tabledata = [];
        var length = _.size(testJSON.zones);
        for(i = 0; i < length; i++) {
          
          var name = _.keys(testJSON.zones)[i];
          
          var population = testJSON.zones[name].population.value;
          if(name == "default") {
            population = testJSON.zones[name].population.default.value;
          }
          
          tabledata[i] = {name, population};
        }
        return {zones: tabledata};
      },
      
      //TODO: add "key" value to array as required by React.js -- (key = zone.name ?)
      render: function() {
        var rows = [];
        this.state.zones.forEach(function(zone) {
            rows.push(<ZoneTableRow Zone={zone.name} Population={zone.population} />);
        }.bind(this));
        
        return (
            <table>
                <thead>
                    <tr>
                        <th>Zone</th>
                        <th>Population</th>
                    </tr>
                </thead>
                <tbody>{rows}</tbody>
            </table>
          );
        }
        
      });
      //NOTE: contentEditable is a HTML5 feature. This will require more code on older HTML versioned browsers
      var ZoneTableRow = React.createClass({
        render: function() {
          return (
              <tr>
                <td>{this.props.Zone}</td>
                <td contentEditable='true'>{this.props.Population}</td>
              </tr>
            );
        }
      });
    
    //TODO: move into main.jsx
    //TODO: remove callback functions if they aren't used anymore
    /* will go in main.jsx */
    var reactComponentMap = React.renderComponent(
      <Map data={testJSON}/>,
      document.getElementById('map'),
      function() {
        // Map Component Callback
      }
    );
    
    var reactComponentTable = React.renderComponent(
      <Table />,
      document.getElementById('table'),
      function() {
        //Table Component Callback
      }
    );

  </script>


</body>
</html>

